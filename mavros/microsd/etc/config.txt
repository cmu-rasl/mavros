#!nsh

set VEHICLE_TYPE mc

set PWM_OUT 5678
set PWM_MIN 1060
set PWM_MAX 1860
set PWM_DISARMED 800

set SYS_USE_IO 1

#Use channels 5678 since channel 1 seems defective
set MIXER quad_da_5678

# Attitue Control Gains
param set MC_ROLL_P         11.500
param set MC_PITCH_P        11.500

param set MC_ROLLRATE_P      0.140
param set MC_PITCHRATE_P     0.180

param set MC_ROLLRATE_I      0.000
param set MC_PITCHRATE_I     0.000

param set MC_ROLLRATE_D      0.004
param set MC_PITCHRATE_D     0.004

param set MC_YAW_P           4.000
param set MC_YAW_FF          0.500

param set MC_YAWRATE_P       0.700
param set MC_YAWRATE_I       0.000
param set MC_YAWRATE_D       0.000
param set MC_YAWRATE_FF      0.000

# Position Control Gains
param set MPC_XY_P           1.500
param set MPC_XY_FF          0.500

param set MPC_XY_VEL_P       0.150
param set MPC_XY_VEL_I       0.000
param set MPC_XY_VEL_D       0.020

param set MPC_Z_P            1.600
param set MPC_Z_FF           0.800

param set MPC_Z_VEL_P        2.000
param set MPC_Z_VEL_I        0.000
param set MPC_Z_VEL_D        0.040

param set MPC_USE_GRAV_FF    1
param set MPC_TOTAL_MASS     0.712
param set MPC_GRAVITY        9.80665
param set MPC_TKOFF_VZSP     0.03

# Angular Velocity L1AC Parameters
param set MC_ENABLE_L1A               1
param set L1A_ACTIVE                  0
param set L1A_ENABLE_DEBUG            1
param set L1A_INERTIA_XX              0.003
param set L1A_INERTIA_YY              0.003
param set L1A_INERTIA_ZZ              0.005
param set L1A_INERTIA_XY              0.000
param set L1A_INERTIA_XZ              0.000
param set L1A_INERTIA_YZ              0.000
param set L1A_CT                      8.65e-9
param set L1A_MOTOR_CONSTANT         36.5
param set L1A_ARM_LENGTH              0.1103
param set L1A_MOMENT_SCALE            0.017
param set L1A_MOTOR_SPREAD_ANGLE      0.925
param set L1A_PWM_MIN              1060.0
param set L1A_PWM_MAX              1860.0
param set L1A_RPM_MIN              3000.0
param set L1A_RPM_MAX             20000.0
param set L1A_BANDWIDTH_X             3.0
param set L1A_BANDWIDTH_Y             3.0
param set L1A_BANDWIDTH_Z             3.0
param set L1A_OBSERVER_GAIN_X       400.0
param set L1A_OBSERVER_GAIN_Y       400.0
param set L1A_OBSERVER_GAIN_Z       400.0
param set L1A_ADAPTATION_GAIN      5000.0
param set L1A_INIT_DISTX              0.0
param set L1A_INIT_DISTY              0.0
param set L1A_INIT_DISTZ              0.0
param set L1A_ENGAGE_LEVEL            0.3

# Linear Velocity L1AC Parameters
param set MPC_ENABLE_L1V              1
param set L1V_ACTIVE                  0
param set L1V_ENABLE_DEBUG            1
param set L1V_CT                      8.65e-9
param set L1V_MOTOR_CONSTANT         36.5
param set L1V_PWM_MIN              1060.0
param set L1V_PWM_MAX              1860.0
param set L1V_RPM_MIN              3000.0
param set L1V_RPM_MAX             20000.0
param set L1V_BANDWIDTH_X             5.0
param set L1V_BANDWIDTH_Y             5.0
param set L1V_BANDWIDTH_Z             5.0
param set L1V_OBSERVER_GAIN_X       100.0
param set L1V_OBSERVER_GAIN_Y       100.0
param set L1V_OBSERVER_GAIN_Z       100.0
param set L1V_ADAPTATION_GAIN      3000.0
param set L1V_INIT_DISTX              0.0
param set L1V_INIT_DISTY              0.0
param set L1V_INIT_DISTZ              0.0
param set L1V_ENGAGE_LEVEL            0.37

param set INAV_ENABLED       0
param set LPE_ENABLED        1

#disable vision input into local position estimator
param set CBRK_NO_VISION 328754

# Enable Vicon Heading use in attitude_estimator_q
param set ATT_EXT_HDG_M      2

# Give maximum weight to external (vicon) yaw in attitude_estimator_q
param set ATT_W_EXT_HDG      1.0

# Lower the vicon noise in local_position_estimator to trust vicon more
param set LPE_VIC_P          0.005

# Increase the process noise in local_position_estimator to trust vicon more
param set LPE_ACC_XY         0.05
param set LPE_ACC_Z          0.05
param set LPE_PN_B           0.000001

set GPS no

set UAVCAN_ENABLE 0

echo "[init] Starting mavlink at baud 230400"
set MAV_SYS_ID 208
set MAV_COMP_ID 08
set MAVLINK_F "-d /dev/ttyS1 -b 230400 -m custom -x"
